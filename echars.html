<!DOCTYPE html>
<html>
  <head>
    <title>ECharts Sample</title>
    <script src="http://echarts.baidu.com/dist/echarts.min.js"></script>
    <script src="jquery-1.9.min.js"></script>
    <script src="dataTool.min.js"></script>
    <script src="tree.js"></script>
    <script src="digraph.js"></script>
  </head>
  <body>
    <div id="chart" style="width: 1000px; height: 800px;"></div>
    <script>
      var chart = document.getElementById('chart');
      var myChart = echarts.init(chart);

      myChart.hideLoading();
      var categories = [];
      var data = {
        createTimeBegin: '2018-11-01',
        createTimeEnd: '2018-12-14',
        callFrom: '豆豆钱',
        moduleName: '星享贷手机申请评分-201710终审'
      };

      fetch('/test.txt')
        .then(response => response.json())
        .then(data => {
          dealwith(data.result);
        });

      //   $.ajax({
      //     url: 'http://10.200.20.174:9110/rc-analyse/query/modeuleprocess',
      //     dataType: 'json',
      //     contentType: 'application/json',
      //     data: JSON.stringify(data),
      //     type: 'post',
      //     success: function(data) {
      //       graph = data.result;
      //       console.log(data);
      //       for (var i = 0; i < 1; i++) {
      //         categories[i] = {
      //           name: '类目' + i
      //         };
      //       }
      //     //   graph.nodes.forEach(function(node) {
      //     //     node.itemStyle = null;
      //     //     node.value = node.symbolSize;
      //     //     node.symbolSize /= 6;
      //     //     node.label = {
      //     //       normal: {
      //     //         show: node.symbolSize > 30
      //     //       }
      //     //     };
      //     //     node.category = node.attributes.modularity_class;
      //     //   });

      //       dealwith(graph);
      //       return;

      //       option = {
      //         title: {
      //           text: '流程决策',
      //           subtext: 'Default layout',
      //           top: 'bottom',
      //           left: 'right'
      //         },
      //         tooltip: {},
      //         legend: [
      //           {
      //             // selectedMode: 'single',
      //             data: categories.map(function(a) {
      //               return a.name;
      //             })
      //           }
      //         ],
      //         animationDuration: 1500,
      //         animationEasingUpdate: 'quinticInOut',
      //         series: [
      //           {
      //             name: '流程决策',
      //             type: 'graph',
      //             layout: 'none',
      //             data: graph.nodes,
      //             links: graph.links,
      //             categories: categories,
      //             roam: true,
      //             focusNodeAdjacency: true,
      //             itemStyle: {
      //               normal: {
      //                 borderColor: '#fff',
      //                 borderWidth: 1,
      //                 shadowBlur: 10,
      //                 shadowColor: 'rgba(0, 0, 0, 0.3)'
      //               }
      //             },
      //             label: {
      //               position: 'right',
      //               formatter: '{b}'
      //             },
      //             lineStyle: {
      //               color: 'source',
      //               curveness: 0.3
      //             },
      //             emphasis: {
      //               lineStyle: {
      //                 width: 10
      //               }
      //             }
      //           }
      //         ]
      //       };

      //   myChart.setOption(option);
      // }

      function dealwith(graph) {
        console.log(graph);
        const nodes = [];
        const links = [];
        for (let item of graph.nodes) {
          nodes.push(
            new Vertex(
              item.id,
              item.name,
              item.attributes,
              item.x,
              item.y,
              item.symbolSize
            )
          );
        }
        for (let item of graph.links) {
          links.push(new DirectedEdge(item.source, item.target, item.id));
        }
        const graph1 = new Digraph(nodes, links);
        console.log(graph1);
        console.log(graph1.loops());
        let fromVertexId = graph1.loops()[0].targetId;
        //   const rootNode = graph1.vertices[id];
        const preferQueue = [];
        const rootNode = new Node(fromVertexId);
        const candidateTree = new Tree(rootNode);
        preferQueue.push(
          ...graph1
            .getInEdgesByVertexId(fromVertexId)
            .map(edge => [fromVertexId, edge.originalId])
        );
        while (preferQueue.length > 0) {
          const pair = preferQueue.shift();
          const parentVertexId = pair[0];
          const currentVertexId = pair[1];

          // Add the edge to the candidate tree
          const parentNodes = candidateTree.search(node => {
            return node.name === parentVertexId;
          });
          const currentNode = new Node(currentVertexId);
          parentNodes.forEach(parentNode => {
            candidateTree.addNode(currentNode, parentNode);
          });
          if (currentVertexId === fromVertexId) {
            continue;
          }
          // Add the next vertex into the prefer queue
          let inEdges = graph1.getInEdgesByVertexId(currentVertexId);
          if (inEdges.length <= 0) {
            continue;
          }
          // 过滤点已存在的数节点
          inEdges = inEdges.filter(
            edge =>
              candidateTree.search(node => node.name === edge.originalId)
                .length === 0
          );
          preferQueue.push(
            ...inEdges.map(edge => [currentVertexId, edge.originalId])
          );
        }
        while (candidateTree.length > 0) {}
      }
    </script>
  </body>
</html>
